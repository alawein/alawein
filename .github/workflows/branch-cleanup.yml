name: Branch Cleanup

on:
  # Run after PRs are merged
  pull_request:
    types: [closed]
  # Weekly cleanup of stale branches
  schedule:
    - cron: '0 3 * * 0' # Every Sunday at 3 AM UTC
  # Manual trigger
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no deletions)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  # Delete merged branch after PR merge
  delete-merged-branch:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Delete merged branch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = context.payload.pull_request.head.ref;
            const protectedBranches = ['main', 'develop', 'staging', 'production'];

            if (protectedBranches.includes(branch)) {
              console.log(`Skipping protected branch: ${branch}`);
              return;
            }

            try {
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branch}`
              });
              console.log(`Successfully deleted branch: ${branch}`);
            } catch (error) {
              console.log(`Could not delete branch ${branch}: ${error.message}`);
            }

  # Clean up stale branches (no commits in 60+ days)
  cleanup-stale-branches:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find and delete stale branches
        uses: actions/github-script@v7
        env:
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const dryRun = process.env.DRY_RUN === 'true';
            const protectedBranches = ['main', 'develop', 'staging', 'production'];
            const staleThresholdDays = 60;
            const staleDate = new Date();
            staleDate.setDate(staleDate.getDate() - staleThresholdDays);

            console.log(`Finding branches with no commits since ${staleDate.toISOString()}`);
            if (dryRun) console.log('DRY RUN MODE - No branches will be deleted');

            const { data: branches } = await github.rest.repos.listBranches({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            let deletedCount = 0;
            let skippedCount = 0;

            for (const branch of branches) {
              if (protectedBranches.includes(branch.name)) {
                console.log(`Skipping protected branch: ${branch.name}`);
                skippedCount++;
                continue;
              }

              // Get the latest commit date
              const { data: commit } = await github.rest.repos.getCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: branch.commit.sha
              });

              const commitDate = new Date(commit.commit.committer.date);

              if (commitDate < staleDate) {
                console.log(`Stale branch: ${branch.name} (last commit: ${commitDate.toISOString()})`);

                if (!dryRun) {
                  try {
                    await github.rest.git.deleteRef({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      ref: `heads/${branch.name}`
                    });
                    console.log(`  -> Deleted`);
                    deletedCount++;
                  } catch (error) {
                    console.log(`  -> Failed to delete: ${error.message}`);
                  }
                } else {
                  console.log(`  -> Would delete (dry run)`);
                  deletedCount++;
                }
              }
            }

            console.log(`\nSummary: ${deletedCount} stale branches ${dryRun ? 'would be ' : ''}deleted, ${skippedCount} protected branches skipped`);

