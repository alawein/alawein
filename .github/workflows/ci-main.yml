name: CI - Main Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Quick validation
  validate:
    name: Quick Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run format:check

      - name: Validate docs
        run: npm run docs:validate

  # Type checking with Turbo
  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check (Turbo + TypeScript Project References)
        run: npx turbo type-check

      - name: Cache TypeScript build info
        uses: actions/cache@v4
        with:
          path: |
            **/.tsbuildinfo
            **/dist/.tsbuildinfo
          key: ${{ runner.os }}-tsc-${{ hashFiles('**/tsconfig*.json') }}

  # Linting with Turbo
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint (Turbo)
        run: npx turbo lint

  # Testing with Turbo
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests (Turbo)
        run: npx turbo test:run

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/coverage-final.json
          fail_ci_if_error: false

  # Build all packages with Turbo
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [type-check, lint]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build all packages (Turbo)
        run: npx turbo build

      - name: Cache Turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

  # Matrix build for specific projects
  build-projects:
    name: Build ${{ matrix.project.name }}
    runs-on: ubuntu-latest
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        project:
          - name: llmworks
            path: platforms/llmworks
          - name: portfolio
            path: platforms/portfolio
          - name: qmlab
            path: platforms/qmlab
          - name: attributa
            path: platforms/attributa
          - name: simcore
            path: platforms/simcore
          - name: liveiticonic
            path: platforms/liveiticonic
          - name: repz
            path: platforms/repz

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build ${{ matrix.project.name }}
        run: npx turbo build --filter=${{ matrix.project.name }}

      - name: Check bundle size
        if: matrix.project.name != 'simcore'
        run: |
          if [ -f "${{ matrix.project.path }}/dist/assets/index-*.js" ]; then
            SIZE=$(stat -f%z "${{ matrix.project.path }}/dist/assets/index-*.js" 2>/dev/null || stat -c%s "${{ matrix.project.path }}/dist/assets/index-*.js")
            echo "Bundle size: $SIZE bytes"
            if [ $SIZE -gt 204800 ]; then
              echo "::warning::Bundle size exceeds 200KB limit"
            fi
          fi

  # Final status check
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [type-check, lint, test, build, build-projects]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.type-check.result }}" != "success" ] || \
             [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.build-projects.result }}" != "success" ]; then
            echo "One or more CI jobs failed"
            exit 1
          fi
          echo "All CI jobs passed successfully!"
