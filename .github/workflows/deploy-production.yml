name: Deploy - Production

on:
  push:
    branches: [main]
    paths:
      - 'organizations/**'
      - 'packages/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - staging
      project:
        description: 'Project to deploy (or "all")'
        required: true
        type: string
        default: 'all'

concurrency:
  group: deploy-${{ github.ref }}-${{ inputs.environment || 'production' }}
  cancel-in-progress: false

jobs:
  # Determine what changed
  detect_changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      llmworks: ${{ steps.filter.outputs.llmworks }}
      portfolio: ${{ steps.filter.outputs.portfolio }}
      qmlab: ${{ steps.filter.outputs.qmlab }}
      attributa: ${{ steps.filter.outputs.attributa }}
      liveiticonic: ${{ steps.filter.outputs.liveiticonic }}
      repz: ${{ steps.filter.outputs.repz }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            llmworks:
              - 'organizations/alawein-technologies-llc/saas/llmworks/**'
              - 'packages/**'
            portfolio:
              - 'organizations/alawein-technologies-llc/saas/portfolio/**'
              - 'packages/**'
            qmlab:
              - 'organizations/alawein-technologies-llc/saas/qmlab/**'
              - 'packages/**'
            attributa:
              - 'organizations/alawein-technologies-llc/saas/attributa/**'
              - 'packages/**'
            liveiticonic:
              - 'organizations/live-it-iconic-llc/ecommerce/liveiticonic/**'
              - 'packages/**'
            repz:
              - 'organizations/repz-llc/apps/repz/**'
              - 'packages/**'
            docs:
              - 'docs/**'
              - 'mkdocs.yaml'

  # Build all changed projects
  build:
    name: Build for Production
    runs-on: ubuntu-latest
    needs: detect_changes
    if: |
      needs.detect_changes.outputs.llmworks == 'true' ||
      needs.detect_changes.outputs.portfolio == 'true' ||
      needs.detect_changes.outputs.qmlab == 'true' ||
      needs.detect_changes.outputs.attributa == 'true' ||
      needs.detect_changes.outputs.liveiticonic == 'true' ||
      needs.detect_changes.outputs.repz == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build changed projects (Turbo)
        run: npx turbo build --filter='[HEAD^1]'
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            organizations/**/dist
            organizations/**/.next
          retention-days: 1

  # Deploy LLMWorks
  deploy_llmworks:
    name: Deploy LLMWorks
    needs: [detect_changes, build]
    if: needs.detect_changes.outputs.llmworks == 'true' || github.event.inputs.project == 'llmworks' || github.event.inputs.project == 'all'
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      working-directory: organizations/alawein-technologies-llc/saas/llmworks
      environment: ${{ inputs.environment || 'production' }}
    secrets: inherit

  # Deploy Portfolio
  deploy_portfolio:
    name: Deploy Portfolio
    needs: [detect_changes, build]
    if: needs.detect_changes.outputs.portfolio == 'true' || github.event.inputs.project == 'portfolio' || github.event.inputs.project == 'all'
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      working-directory: organizations/alawein-technologies-llc/saas/portfolio
      environment: ${{ inputs.environment || 'production' }}
    secrets: inherit

  # Deploy QMLab
  deploy_qmlab:
    name: Deploy QMLab
    needs: [detect_changes, build]
    if: needs.detect_changes.outputs.qmlab == 'true' || github.event.inputs.project == 'qmlab' || github.event.inputs.project == 'all'
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      working-directory: organizations/alawein-technologies-llc/saas/qmlab
      environment: ${{ inputs.environment || 'production' }}
    secrets: inherit

  # Deploy Attributa
  deploy_attributa:
    name: Deploy Attributa
    needs: [detect_changes, build]
    if: needs.detect_changes.outputs.attributa == 'true' || github.event.inputs.project == 'attributa' || github.event.inputs.project == 'all'
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      working-directory: organizations/alawein-technologies-llc/saas/attributa
      environment: ${{ inputs.environment || 'production' }}
    secrets: inherit

  # Deploy Live It Iconic
  deploy_liveiticonic:
    name: Deploy Live It Iconic
    needs: [detect_changes, build]
    if: needs.detect_changes.outputs.liveiticonic == 'true' || github.event.inputs.project == 'liveiticonic' || github.event.inputs.project == 'all'
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      working-directory: organizations/live-it-iconic-llc/ecommerce/liveiticonic
      environment: ${{ inputs.environment || 'production' }}
    secrets: inherit

  # Deploy REPZ
  deploy_repz:
    name: Deploy REPZ
    needs: [detect_changes, build]
    if: needs.detect_changes.outputs.repz == 'true' || github.event.inputs.project == 'repz' || github.event.inputs.project == 'all'
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      working-directory: organizations/repz-llc/apps/repz
      environment: ${{ inputs.environment || 'production' }}
    secrets: inherit

  # Deploy Documentation
  deploy_docs:
    name: Deploy Documentation
    needs: detect_changes
    if: needs.detect_changes.outputs.docs == 'true' || github.event.inputs.project == 'docs' || github.event.inputs.project == 'all'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install MkDocs
        run: |
          pip install mkdocs-material
          pip install mkdocs-mermaid2-plugin
      
      - name: Build documentation
        run: mkdocs build
      
      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: site
      
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

  # Deployment summary
  deploy_summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy_llmworks, deploy_portfolio, deploy_qmlab, deploy_attributa, deploy_liveiticonic, deploy_repz, deploy_docs]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployed Projects" >> $GITHUB_STEP_SUMMARY
          echo "- LLMWorks: ${{ needs.deploy_llmworks.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Portfolio: ${{ needs.deploy_portfolio.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- QMLab: ${{ needs.deploy_qmlab.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Attributa: ${{ needs.deploy_attributa.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Live It Iconic: ${{ needs.deploy_liveiticonic.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- REPZ: ${{ needs.deploy_repz.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation: ${{ needs.deploy_docs.result }}" >> $GITHUB_STEP_SUMMARY
