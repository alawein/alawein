name: Documentation Validation

on:
  push:
    paths:
      - 'docs/**'
      - '*.md'
  pull_request:
    paths:
      - 'docs/**'
      - '*.md'
  schedule:
    - cron: '0 6 * * 1' # Weekly on Monday at 6 AM

jobs:
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest
    env:
      CANONICAL_DOCS_BASE_URL: https://docs.morphism.systems
      LEGACY_DOCS_DOMAIN: docs.github-alawein.com
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || echo "No package.json found, using fallback tools"

      - name: Validate markdown syntax
        run: |
          npx markdownlint "**/*.md" --ignore node_modules || echo "Markdown linting completed"

      - name: Enforce canonical docs base URL
        run: |
          echo "Canonical docs base URL: $CANONICAL_DOCS_BASE_URL"
          echo "Blocking legacy docs domain: $LEGACY_DOCS_DOMAIN"
          if grep -RIn --exclude-dir=node_modules --include="*.md" "$LEGACY_DOCS_DOMAIN" .; then
            echo "Found legacy docs domain '$LEGACY_DOCS_DOMAIN'."
            echo "Please replace it with '$CANONICAL_DOCS_BASE_URL' (or another approved Morphism Systems URL)."
            exit 1
          fi

      - name: Check for broken links
        run: |
          npx markdown-link-check "**/*.md" --progress --quiet || echo "Link checking completed"

      - name: Validate documentation structure
        run: |
          echo "Checking documentation structure..."
          find docs/ -name "*.md" 2>/dev/null | wc -l | xargs echo "Found markdown files in docs/:"
          find . -maxdepth 1 -name "*.md" | wc -l | xargs echo "Found markdown files in root:"
          echo "Documentation structure validated"

      - name: Generate documentation report
        run: |
          echo "# Documentation Validation Report" > docs-validation-report.md
          echo "" >> docs-validation-report.md
          echo "## Validation Results" >> docs-validation-report.md
          echo "- âœ… Markdown syntax validation completed" >> docs-validation-report.md
          echo "- âœ… Link validation completed" >> docs-validation-report.md
          echo "- âœ… Documentation structure validated" >> docs-validation-report.md
          echo "" >> docs-validation-report.md
          echo "## Repository Type" >> docs-validation-report.md
          echo "- Morphism Systems documentation repository" >> docs-validation-report.md
          echo "- Contains README(s), documentation, and governance artifacts" >> docs-validation-report.md
          echo "" >> docs-validation-report.md
          echo "## Generated on $(date)" >> docs-validation-report.md

      - name: Upload documentation report
        uses: actions/upload-artifact@v4
        with:
          name: docs-validation-report
          path: docs-validation-report.md

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('docs-validation-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ“š Documentation Validation Report\n\n${report}`
            });

  summary:
    name: Documentation Summary
    runs-on: ubuntu-latest
    needs: validate-docs
    if: always()
    steps:
      - name: Display summary
        run: |
          echo "## ðŸ“‹ Documentation Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Documentation Validation**: ${{ needs.validate-docs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Notes" >> $GITHUB_STEP_SUMMARY
          echo "- This repository contains Morphism Systems documentation" >> $GITHUB_STEP_SUMMARY
          echo "- Validation focuses on markdown syntax and link integrity" >> $GITHUB_STEP_SUMMARY
          echo "- Reports are available as artifacts for download" >> $GITHUB_STEP_SUMMARY
