name: Governance Enforcement

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop, production]
  push:
    branches: [main, develop, production]
  schedule:
    - cron: '0 0 * * 1' # Weekly on Monday
  workflow_dispatch:

env:
  GOVERNANCE_LOG_LEVEL: info

jobs:
  classify-repository:
    runs-on: ubuntu-latest
    outputs:
      tier: ${{ steps.classify.outputs.tier }}
      requires-reviewers: ${{ steps.classify.outputs.requires-reviewers }}
      requires-security: ${{ steps.classify.outputs.requires-security }}
    steps:
      - name: Classify Repository
        id: classify
        run: |
          # Determine repository tier based on organization and name
          REPO_NAME="${{ github.repository }}"

          case "$REPO_NAME" in
            "repz-llc/repz"|"live-it-iconic-llc/liveiticonic"|"family-platforms/family-platforms")
              echo "tier=production" >> $GITHUB_OUTPUT
              echo "requires-reviewers=2" >> $GITHUB_OUTPUT
              echo "requires-security=true" >> $GITHUB_OUTPUT
              ;;
            "alawein-technologies-llc/"*)
              echo "tier=development" >> $GITHUB_OUTPUT
              echo "requires-reviewers=1" >> $GITHUB_OUTPUT
              echo "requires-security=false" >> $GITHUB_OUTPUT
              ;;
            "research/"*)
              echo "tier=research" >> $GITHUB_OUTPUT
              echo "requires-reviewers=1" >> $GITHUB_OUTPUT
              echo "requires-security=false" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "tier=standard" >> $GITHUB_OUTPUT
              echo "requires-reviewers=1" >> $GITHUB_OUTPUT
              echo "requires-security=false" >> $GITHUB_OUTPUT
              ;;
          esac

  check-approvals:
    runs-on: ubuntu-latest
    needs: classify-repository
    if: github.event_name == 'pull_request'
    steps:
      - name: Check Required Approvals
        uses: actions/github-script@v6
        with:
          script: |
            const requiredReviewers = '${{ needs.classify-repository.outputs.requires-reviewers }}';
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const approvals = reviews.filter(review => review.state === 'APPROVED');
            const uniqueApprovers = new Set(approvals.map(r => r.user.login));

            console.log(`Required reviewers: ${requiredReviewers}`);
            console.log(`Current approvals: ${uniqueApprovers.size}`);
            console.log(`Approvers: ${Array.from(uniqueApprovers).join(', ')}`);

            if (uniqueApprovers.size < parseInt(requiredReviewers)) {
              core.setFailed(`Insufficient approvals. Required: ${requiredReviewers}, Current: ${uniqueApprovers.size}`);
            }

  check-codeowners:
    runs-on: ubuntu-llient
    needs: classify-repository
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check CODEOWNERS Approval
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Read CODEOWNERS file
            let codeownersContent = '';
            try {
              codeownersContent = fs.readFileSync('.github/CODEOWNERS', 'utf8');
            } catch (error) {
              console.log('No CODEOWNERS file found');
              return;
            }

            // Get changed files
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            // Parse CODEOWNERS and check if required approvals are present
            const codeownersLines = codeownersContent.split('\n');
            const requiredOwners = new Set();

            for (const line of codeownersLines) {
              if (line.trim() && !line.startsWith('#')) {
                const [pattern, ...owners] = line.split(/\s+/);
                if (owners.length > 0) {
                  requiredOwners.add(owners[0]);
                }
              }
            }

            // Get current approvals
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const approvers = reviews
              .filter(review => review.state === 'APPROVED')
              .map(review => review.user.login);

            // Check if required owners have approved
            const missingApprovals = Array.from(requiredOwners).filter(
              owner => !approvers.includes(owner.replace('@', ''))
            );

            if (missingApprovals.length > 0) {
              core.warning(`Missing CODEOWNERS approvals from: ${missingApprovals.join(', ')}`);
            }

  security-scan:
    runs-on: ubuntu-latest
    needs: classify-repository
    if: needs.classify-repository.outputs.requires-security == 'true'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy Scan Results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          languages: ${{ matrix.language }}
        strategy:
          matrix:
            language: ['javascript', 'python', 'typescript']

  license-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check License Compliance
        uses: fossa-contrib/fossa-action@v2
        with:
          api-key: ${{ secrets.FOSSA_API_KEY }}
          run-tests: true

  dependency-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Audit Dependencies
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Audit Python Dependencies
        uses: pypa/gh-action-pip-audit@v1.1.0
        with:
          inputs: requirements.txt
        continue-on-error: true

  compliance-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check Compliance Requirements
        uses: actions/github-script@v6
        with:
          script: |
            const repoName = context.repo.repo;
            const repoOwner = context.repo.owner;

            // Check if repository has required files
            const requiredFiles = [
              'LICENSE',
              'README.md',
              '.github/CODEOWNERS',
              '.github/SECURITY.md'
            ];

            for (const file of requiredFiles) {
              try {
                await github.rest.repos.getContent({
                  owner: repoOwner,
                  repo: repoName,
                  path: file
                });
                console.log(`✅ ${file} found`);
              } catch (error) {
                console.log(`❌ ${file} missing`);
                core.warning(`Required file ${file} is missing`);
              }
            }

            // Check branch protection rules
            try {
              const { data: branch } = await github.rest.repos.getBranch({
                owner: repoOwner,
                repo: repoName,
                branch: 'main'
              });

              if (branch.protected) {
                console.log('✅ Main branch is protected');
              } else {
                core.warning('Main branch is not protected');
              }
            } catch (error) {
              core.warning('Could not check branch protection');
            }

  repository-health:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Check Repository Health
        uses: actions/github-script@v6
        with:
          script: |
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;

            // Get repository statistics
            const { data: repo } = await github.rest.repos.get({
              owner: repoOwner,
              repo: repoName
            });

            // Check last activity
            const lastCommit = new Date(repo.pushed_at);
            const daysSinceLastCommit = Math.floor((new Date() - lastCommit) / (1000 * 60 * 60 * 24));

            console.log(`Repository: ${repo.full_name}`);
            console.log(`Last activity: ${daysSinceLastCommit} days ago`);
            console.log(`Open issues: ${repo.open_issues_count}`);
            console.log(`Stars: ${repo.stargazers_count}`);
            console.log(`Forks: ${repo.forks_count}`);

            // Flag inactive repositories
            if (daysSinceLastCommit > 180) {
              core.warning(`Repository has been inactive for ${daysSinceLastCommit} days`);
            }

            // Create issue for inactive repos
            if (daysSinceLastCommit > 365) {
              await github.rest.issues.create({
                owner: repoOwner,
                repo: repoName,
                title: 'Repository Inactivity Review',
                body: `This repository has been inactive for ${daysSinceLastCommit} days. Please consider archiving or updating the repository.`,
                labels: ['maintenance', 'inactive-review']
              });
            }

  team-access-audit:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Audit Team Access
        uses: actions/github-script@v6
        with:
          script: |
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;

            // Get repository collaborators
            const { data: collaborators } = await github.rest.repos.listCollaborators({
              owner: repoOwner,
              repo: repoName,
              affiliation: 'all'
            });

            console.log(`Repository: ${repoOwner}/${repoName}`);
            console.log(`Total collaborators: ${collaborators.length}`);

            // Check for unusual access patterns
            const directCollaborators = collaborators.filter(c => c.type === 'User');
            const teamCollaborators = collaborators.filter(c => c.type === 'Team');

            console.log(`Direct collaborators: ${directCollaborators.length}`);
            console.log(`Team collaborators: ${teamCollaborators.length}`);

            // Flag repositories with too many direct collaborators
            if (directCollaborators.length > 10) {
              core.warning(`Repository has ${directCollaborators.length} direct collaborators. Consider using teams.`);
            }

            // Check for external collaborators
            const externalCollaborators = directCollaborators.filter(c =>
              !c.login.includes('alawein') &&
              !c.login.includes('meshal') &&
              c.permissions.push
            );

            if (externalCollaborators.length > 0) {
              console.log(`External collaborators with write access: ${externalCollaborators.map(c => c.login).join(', ')}`);
            }

  policy-compliance:
    runs-on: ubuntu-latest
    steps:
      - name: Check Policy Compliance
        uses: actions/github-script@v6
        with:
          script: |
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;

            // Define compliance requirements based on repository tier
            const complianceRequirements = {
              'repz-llc/repz': {
                requires2FA: true,
                requiresSOS: true,
                requiresCodeOwners: true,
                requiresSecurityPolicy: true,
                requiresBranchProtection: true
              },
              'live-it-iconic-llc/liveiticonic': {
                requires2FA: true,
                requiresSOS: true,
                requiresCodeOwners: true,
                requiresSecurityPolicy: true,
                requiresBranchProtection: true
              },
              'family-platforms/family-platforms': {
                requires2FA: true,
                requiresSOS: true,
                requiresCodeOwners: true,
                requiresSecurityPolicy: true,
                requiresBranchProtection: true
              }
            };

            const requirements = complianceRequirements[`${repoOwner}/${repoName}`];

            if (!requirements) {
              console.log('No specific compliance requirements for this repository');
              return;
            }

            // Check each requirement
            const complianceResults = {};

            // Check 2FA requirement
            if (requirements.requires2FA) {
              try {
                const { data: org } = await github.rest.orgs.get({
                  org: repoOwner
                });
                complianceResults.twoFactor = org.two_factor_requirement_enabled;
              } catch (error) {
                complianceResults.twoFactor = false;
              }
            }

            // Check branch protection
            if (requirements.requiresBranchProtection) {
              try {
                const { data: branch } = await github.rest.repos.getBranch({
                  owner: repoOwner,
                  repo: repoName,
                  branch: 'main'
                });
                complianceResults.branchProtection = branch.protected;
              } catch (error) {
                complianceResults.branchProtection = false;
              }
            }

            // Report compliance status
            console.log('Compliance Results:');
            Object.entries(complianceResults).forEach(([requirement, compliant]) => {
              const status = compliant ? '✅' : '❌';
              console.log(`${status} ${requirement}: ${compliant}`);
            });

            // Fail if critical requirements are not met
            const criticalFailures = Object.entries(complianceResults)
              .filter(([req, compliant]) => !compliant && req === 'branchProtection');

            if (criticalFailures.length > 0) {
              core.setFailed('Critical compliance requirements not met');
            }

  notify-governance:
    runs-on: ubuntu-latest
    needs: [classify-repository, check-approvals, security-scan, compliance-check]
    if: always()
    steps:
      - name: Notify Governance Team
        uses: actions/github-script@v6
        with:
          script: |
            const results = {
              classification: '${{ needs.classify-repository.outputs.tier }}',
              approvals: '${{ needs.check-approvals.result }}',
              security: '${{ needs.security-scan.result }}',
              compliance: '${{ needs.compliance-check.result }}'
            };

            // Send notification to governance team if there are failures
            const hasFailures = Object.values(results).some(result => result === 'failure');

            if (hasFailures) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Governance Check Failed',
                body: `Governance checks failed for PR #${context.issue.number}\n\nResults: ${JSON.stringify(results, null, 2)}`,
                labels: ['governance', 'failed-check']
              });
            }
