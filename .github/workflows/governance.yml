name: Governance & Policy Enforcement

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday
  workflow_dispatch:

concurrency:
  group: governance-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # AI Governance Audit
  ai_governance:
    name: AI Governance Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run AI governance checks
        run: |
          if [ -f "tools/ai/governance.ts" ]; then
            npx tsx tools/ai/governance.ts audit
          else
            echo "AI governance tool not found, skipping"
          fi
      
      - name: Upload AI governance report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-governance-report
          path: reports/ai-governance-*.json
          retention-days: 30

  # Structure Validation
  structure_validation:
    name: Repository Structure Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Validate repository structure
        run: |
          # Check required directories exist
          required_dirs=("docs" "packages" "organizations" "tools" "scripts")
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "::error::Required directory '$dir' not found"
              exit 1
            fi
          done
          
          # Check required files exist
          required_files=("package.json" "tsconfig.json" "turbo.json" "README.md")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "::error::Required file '$file' not found"
              exit 1
            fi
          done
          
          echo "✅ Repository structure validation passed"
      
      - name: Validate workspace structure
        run: |
          # Validate all workspaces have package.json
          for workspace in organizations/*/apps/* organizations/*/saas/* organizations/*/ecommerce/* packages/*; do
            if [ -d "$workspace" ] && [ ! -f "$workspace/package.json" ]; then
              echo "::warning::Workspace '$workspace' missing package.json"
            fi
          done

  # Policy Enforcement
  policy_enforcement:
    name: Policy Enforcement
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check naming conventions
        run: |
          # Check for proper naming in packages
          for pkg in packages/*; do
            if [ -d "$pkg" ]; then
              pkg_name=$(basename "$pkg")
              if [[ ! "$pkg_name" =~ ^[a-z][a-z0-9-]*$ ]]; then
                echo "::error::Package '$pkg_name' violates naming convention (lowercase, hyphens only)"
                exit 1
              fi
            fi
          done
          echo "✅ Naming conventions check passed"
      
      - name: Check for duplicate dependencies
        run: |
          # Find duplicate dependencies across workspaces
          echo "Checking for duplicate dependencies..."
          npm run health || echo "Health check completed with warnings"
      
      - name: Validate TypeScript configs
        run: |
          # Ensure all TypeScript projects have proper configs
          for tsconfig in **/tsconfig.json; do
            if [ -f "$tsconfig" ]; then
              echo "Validating $tsconfig"
              npx tsc --project "$tsconfig" --noEmit --skipLibCheck || echo "::warning::TypeScript errors in $tsconfig"
            fi
          done

  # Documentation Governance
  docs_governance:
    name: Documentation Governance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      
      - name: Check README files
        run: |
          # Ensure all major directories have README files
          for dir in organizations/* packages/*; do
            if [ -d "$dir" ] && [ ! -f "$dir/README.md" ]; then
              echo "::warning::Directory '$dir' missing README.md"
            fi
          done
      
      - name: Validate documentation links
        run: |
          if [ -f "scripts/validate-docs.js" ]; then
            node scripts/validate-docs.js
          else
            echo "Documentation validation script not found"
          fi
      
      - name: Check for outdated docs
        run: |
          # Find docs that haven't been updated in 90 days
          find docs -name "*.md" -mtime +90 -type f | while read file; do
            echo "::warning::Documentation file '$file' hasn't been updated in 90+ days"
          done

  # Orchestration Governance
  orchestration_governance:
    name: Orchestration Governance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Validate Turbo configuration
        run: |
          if [ -f "turbo.json" ]; then
            echo "Validating turbo.json..."
            node -e "const config = require('./turbo.json'); console.log('✅ Turbo config valid');"
          fi
      
      - name: Check workspace dependencies
        run: |
          echo "Checking workspace dependency graph..."
          npm run health || true
      
      - name: Validate CI/CD workflows
        run: |
          # Check all workflows are valid YAML
          for workflow in .github/workflows/*.yml; do
            echo "Validating $workflow"
            python -c "import yaml; yaml.safe_load(open('$workflow'))" || echo "::error::Invalid YAML in $workflow"
          done

  # Security Policy Check
  security_policy:
    name: Security Policy Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check security files
        run: |
          required_security_files=("SECURITY.md" ".gitignore" ".secrets.baseline")
          for file in "${required_security_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "::error::Required security file '$file' not found"
              exit 1
            fi
          done
          echo "✅ Security files check passed"
      
      - name: Check for exposed secrets
        run: |
          # Basic check for common secret patterns
          if grep -r -E "(api[_-]?key|password|secret|token).*=.*['\"][^'\"]{20,}" --exclude-dir=node_modules --exclude-dir=.git .; then
            echo "::warning::Potential exposed secrets found"
          fi
      
      - name: Validate .gitignore
        run: |
          required_ignores=("node_modules" ".env" "dist" "build" ".DS_Store")
          for pattern in "${required_ignores[@]}"; do
            if ! grep -q "$pattern" .gitignore; then
              echo "::warning::.gitignore missing pattern: $pattern"
            fi
          done

  # Governance Summary
  governance_summary:
    name: Governance Summary
    runs-on: ubuntu-latest
    needs: [ai_governance, structure_validation, policy_enforcement, docs_governance, orchestration_governance, security_policy]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "# Governance Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "- AI Governance: ${{ needs.ai_governance.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Structure Validation: ${{ needs.structure_validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Policy Enforcement: ${{ needs.policy_enforcement.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation Governance: ${{ needs.docs_governance.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Orchestration Governance: ${{ needs.orchestration_governance.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Policy: ${{ needs.security_policy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.ai_governance.result }}" == "success" ] && \
             [ "${{ needs.structure_validation.result }}" == "success" ] && \
             [ "${{ needs.policy_enforcement.result }}" == "success" ] && \
             [ "${{ needs.docs_governance.result }}" == "success" ] && \
             [ "${{ needs.orchestration_governance.result }}" == "success" ] && \
             [ "${{ needs.security_policy.result }}" == "success" ]; then
            echo "✅ All governance checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Some governance checks failed or had warnings" >> $GITHUB_STEP_SUMMARY
          fi
