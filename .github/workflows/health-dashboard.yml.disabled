name: Health Dashboard

on:
  schedule:
    - cron: '0 6 * * 1' # Weekly on Monday at 6 AM
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  generate-dashboard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r .metaHub/scripts/requirements.txt

      - name: Generate structure report
        run: |
          mkdir -p .metaHub/reports
          if [ -d "organizations" ] && [ "$(ls -A organizations 2>/dev/null)" ]; then
            python .metaHub/scripts/structure_validator.py \
              --report json \
              --output .metaHub/reports/structure-report.json
          else
            echo '{"summary": {"total_repos": 0, "compliant": 0, "compliance_rate": 0}}' > .metaHub/reports/structure-report.json
          fi

      - name: Generate catalog
        run: |
          if [ -d "organizations" ] && [ "$(ls -A organizations 2>/dev/null)" ]; then
            python .metaHub/scripts/catalog.py \
              --format json \
              --quiet 2>/dev/null || echo '{"summary": {"total_repositories": 0}}' > .metaHub/catalog/catalog.json
          fi

      - name: Generate health dashboard
        run: |
          cat > .metaHub/reports/HEALTH_DASHBOARD.md << 'DASHBOARD'
          # Portfolio Health Dashboard

          > Last updated: $(date -u +"%Y-%m-%d %H:%M UTC")

          ## Quick Stats

          | Metric | Value |
          |--------|-------|
          DASHBOARD

          # Add structure stats
          if [ -f ".metaHub/reports/structure-report.json" ]; then
            python3 -c "
          import json
          d = json.load(open('.metaHub/reports/structure-report.json'))
          s = d.get('summary', {})
          print(f\"| Total Repos | {s.get('total_repos', 0)} |\")
          print(f\"| Compliant | {s.get('compliant', 0)} |\")
          print(f\"| Compliance Rate | {s.get('compliance_rate', 0)}% |\")
          " >> .metaHub/reports/HEALTH_DASHBOARD.md
          fi

          cat >> .metaHub/reports/HEALTH_DASHBOARD.md << 'DASHBOARD'

          ## Organization Breakdown

          | Organization | Repos | Compliant | Rate |
          |--------------|-------|-----------|------|
          DASHBOARD

          # Add org breakdown
          if [ -f ".metaHub/reports/structure-report.json" ]; then
            python3 -c "
          import json
          d = json.load(open('.metaHub/reports/structure-report.json'))
          for org, data in d.get('organizations', {}).items():
              s = data.get('summary', {})
              total = s.get('total_repos', 0)
              compliant = s.get('compliant', 0)
              rate = round(compliant/total*100, 1) if total > 0 else 0
              print(f'| {org} | {total} | {compliant} | {rate}% |')
          " >> .metaHub/reports/HEALTH_DASHBOARD.md
          fi

          cat >> .metaHub/reports/HEALTH_DASHBOARD.md << 'DASHBOARD'

          ## Language Distribution

          | Language | Count |
          |----------|-------|
          DASHBOARD

          # Add language stats
          if [ -f ".metaHub/reports/structure-report.json" ]; then
            python3 -c "
          import json
          from collections import Counter
          d = json.load(open('.metaHub/reports/structure-report.json'))
          langs = Counter()
          for org, data in d.get('organizations', {}).items():
              for repo in data.get('repos', []):
                  lang = repo.get('detected_language', 'unknown')
                  langs[lang] += 1
          for lang, count in langs.most_common():
              print(f'| {lang} | {count} |')
          " >> .metaHub/reports/HEALTH_DASHBOARD.md
          fi

          cat >> .metaHub/reports/HEALTH_DASHBOARD.md << 'DASHBOARD'

          ## Type Distribution

          | Type | Count |
          |------|-------|
          DASHBOARD

          # Add type stats
          if [ -f ".metaHub/reports/structure-report.json" ]; then
            python3 -c "
          import json
          from collections import Counter
          d = json.load(open('.metaHub/reports/structure-report.json'))
          types = Counter()
          for org, data in d.get('organizations', {}).items():
              for repo in data.get('repos', []):
                  t = repo.get('detected_type', 'unknown')
                  types[t] += 1
          for t, count in types.most_common():
              print(f'| {t} | {count} |')
          " >> .metaHub/reports/HEALTH_DASHBOARD.md
          fi

          cat >> .metaHub/reports/HEALTH_DASHBOARD.md << 'DASHBOARD'

          ---

          *Generated by [Health Dashboard Workflow](.github/workflows/health-dashboard.yml)*
          DASHBOARD

      - name: Commit dashboard
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .metaHub/reports/HEALTH_DASHBOARD.md
          git diff --cached --quiet || git commit -m "chore: update health dashboard [skip ci]"
          git push || echo "No changes to push"
