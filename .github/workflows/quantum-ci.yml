name: Quantum-Classical CI/CD Pipeline

on:
  push:
    branches: [ main, develop, quantum-* ]
  pull_request:
    branches: [ main, develop ]

env:
  QUANTUM_BACKENDS: "qiskit_aer,cirq_simulator"
  PHYSICS_VALIDATION: "enabled"
  PERFORMANCE_BENCHMARKS: "enabled"

jobs:
  physics-validation:
    runs-on: ubuntu-latest
    name: Physics Constraints Validation
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install physics validation tools
        run: |
          pip install numpy scipy sympy
          pip install -e ./research/scicomp[all]
      
      - name: Validate Conservation Laws
        run: |
          python scripts/validate_physics.py --check-conservation-laws
          python scripts/validate_physics.py --check-thermodynamics
          python scripts/validate_physics.py --check-quantum-constraints
      
      - name: Check Dimensional Analysis
        run: |
          python scripts/dimensional_analysis.py --all-modules
      
      - name: Validate Physical Units
        run: |
          python scripts/unit_validation.py --strict

  quantum-circuit-validation:
    runs-on: ubuntu-latest
    name: Quantum Circuit Optimization
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install quantum backends
        run: |
          pip install qiskit[all] cirq pennylane
          pip install -e ./research/optilibria[quantum]
          pip install -e ./research/qubeml[quantum]
      
      - name: Validate Quantum Circuits
        run: |
          python scripts/validate_quantum_circuits.py --backend qiskit_aer
          python scripts/validate_quantum_circuits.py --backend cirq_simulator
      
      - name: Optimize Circuit Depth
        run: |
          python scripts/optimize_circuits.py --max-depth 20
      
      - name: Check Quantum Advantage
        run: |
          python scripts/quantum_advantage_analysis.py --threshold 0.1

  performance-benchmarks:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        backend: [cpu, gpu-simulator]
        project: [optilibria, qubeml, scicomp]
    name: Performance Benchmarks (${{ matrix.project }}-${{ matrix.backend }})
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install project dependencies
        run: |
          pip install -e ./research/${{ matrix.project }}[all]
      
      - name: Run performance benchmarks
        run: |
          python scripts/benchmark_${{ matrix.project }}.py --backend ${{ matrix.backend }}
      
      - name: Compare against baselines
        run: |
          python scripts/compare_performance.py \
            --project ${{ matrix.project }} \
            --backend ${{ matrix.backend }} \
            --baseline performance_baselines.json
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v3
        with:
          name: benchmarks-${{ matrix.project }}-${{ matrix.backend }}
          path: benchmarks/

  materials-discovery-tests:
    runs-on: ubuntu-latest
    name: Materials Discovery Pipeline
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install materials science stack
        run: |
          pip install ase pymatgen matminer
          pip install -e ./research/qubeml[materials]
          pip install -e ./research/qmatsim[all]
      
      - name: Test superconductor prediction
        run: |
          python tests/test_superconductor_prediction.py
      
      - name: Test crystal structure optimization
        run: |
          python tests/test_crystal_optimization.py
      
      - name: Validate materials database
        run: |
          python scripts/validate_materials_db.py --check-stability

  quantum-ml-integration:
    runs-on: ubuntu-latest
    name: Quantum ML Integration Tests
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install quantum ML stack
        run: |
          pip install torch torchvision
          pip install qiskit-machine-learning pennylane
          pip install -e ./research/qubeml[all]
      
      - name: Test quantum neural networks
        run: |
          python tests/test_quantum_neural_networks.py
      
      - name: Test hybrid training
        run: |
          python tests/test_hybrid_training.py
      
      - name: Validate physics constraints
        run: |
          python tests/test_physics_informed_ml.py

  orchex-agent-tests:
    runs-on: ubuntu-latest
    name: ORCHEX Multi-Agent System
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install ORCHEX dependencies
        run: |
          pip install asyncio aiohttp
          pip install anthropic openai
          pip install -e ./tools/orchex[all]
      
      - name: Test agent communication
        run: |
          python tests/test_agent_communication.py
      
      - name: Test research orchestration
        run: |
          python tests/test_research_orchestration.py
      
      - name: Validate physics constraints in AI
        run: |
          python tests/test_physics_constrained_ai.py

  security-scan:
    runs-on: ubuntu-latest
    name: Security & Secrets Scan
    steps:
      - uses: actions/checkout@v4
      
      - name: Run secret detection
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
      
      - name: Scan for API keys
        run: |
          python scripts/scan_api_keys.py --strict
      
      - name: Validate quantum backend security
        run: |
          python scripts/validate_quantum_security.py

  documentation-build:
    runs-on: ubuntu-latest
    name: Documentation Generation
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install documentation tools
        run: |
          pip install sphinx sphinx-rtd-theme nbsphinx
          pip install -e ./research/optilibria[docs]
          pip install -e ./research/qubeml[docs]
      
      - name: Generate API documentation
        run: |
          python scripts/generate_api_docs.py --all-projects
      
      - name: Build documentation
        run: |
          sphinx-build -b html docs/ docs/_build/
      
      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/_build

  deploy-quantum-cloud:
    runs-on: ubuntu-latest
    name: Deploy to Quantum Cloud
    if: github.ref == 'refs/heads/main'
    needs: [physics-validation, quantum-circuit-validation, performance-benchmarks]
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to IBM Quantum
        env:
          IBM_QUANTUM_TOKEN: ${{ secrets.IBM_QUANTUM_TOKEN }}
        run: |
          python scripts/deploy_ibm_quantum.py
      
      - name: Deploy to Azure Quantum
        env:
          AZURE_QUANTUM_CREDENTIALS: ${{ secrets.AZURE_QUANTUM_CREDENTIALS }}
        run: |
          python scripts/deploy_azure_quantum.py
      
      - name: Update quantum backend registry
        run: |
          python scripts/update_quantum_registry.py

  performance-report:
    runs-on: ubuntu-latest
    name: Generate Performance Report
    needs: [performance-benchmarks, materials-discovery-tests, quantum-ml-integration]
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all benchmark artifacts
        uses: actions/download-artifact@v3
      
      - name: Generate performance report
        run: |
          python scripts/generate_performance_report.py \
            --benchmarks benchmarks/ \
            --output performance_report.html
      
      - name: Upload performance report
        uses: actions/upload-artifact@v3
        with:
          name: performance-report
          path: performance_report.html
      
      - name: Comment PR with performance results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('performance_report.html', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸš€ Performance Report\n\n${report}`
            });

  notify-success:
    runs-on: ubuntu-latest
    name: Notify Success
    needs: [deploy-quantum-cloud, performance-report]
    if: success()
    steps:
      - name: Notify team
        run: |
          echo "ðŸš€ Quantum-Classical CI/CD Pipeline completed successfully!"
          echo "âœ… Physics validation passed"
          echo "âœ… Quantum circuits optimized" 
          echo "âœ… Performance benchmarks met"
          echo "âœ… Materials discovery tests passed"
          echo "âœ… Quantum ML integration verified"
          echo "âœ… ORCHEX agents operational"
          echo "âœ… Documentation updated"
          echo "âœ… Deployed to quantum cloud"