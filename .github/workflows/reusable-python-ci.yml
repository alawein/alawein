name: Reusable Python CI

on:
  workflow_call:
    inputs:
      python-version:
        description: Python version to test
        required: false
        default: '3.11'
        type: string
      test-command:
        description: Command to run tests
        required: false
        default: 'pytest'
        type: string
      lint-command:
        description: Command to run linting
        required: false
        default: 'ruff check .'
        type: string

permissions:
  contents: read
  packages: write

jobs:
  python-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pytest ruff mypy || true

      - name: Lint with ruff
        run: ${{ inputs.lint-command }}

      - name: Type check with mypy
        run: mypy . --ignore-missing-imports

      - name: Run tests
        run: ${{ inputs.test-command }}

      - name: Generate coverage
        run: |
          pip install coverage
          coverage run -m pytest
          coverage report
          coverage xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  performance-benchmark:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pytest pytest-benchmark || true # Install pytest-benchmark

      - name: Run performance benchmarks
        run: |
          # The --benchmark-save flag saves benchmark data for comparison in future runs
          # The --benchmark-json flag saves results in JSON format for external processing
          pytest tests/performance --benchmark-save=benchmark-results --benchmark-json=benchmark-results.json

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.sha }}
          path: benchmark-results.json
          retention-days: 7

  docker-build-and-push:
    runs-on: ubuntu-latest
    needs: [python-ci, performance-benchmark] # Ensure it runs after other checks
    # Only run if Dockerfile exists in the root of the repo being built
    # (assuming inputs.workdir is not used for Dockerfile path, but for checkout)
    # Only run Docker build on push to main (not on PRs or in the central governance repo)
    if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for Dockerfile
        id: check_dockerfile
        run: |
          if [ -f Dockerfile ]; then
            echo "DOCKERFILE_EXISTS=true" >> $GITHUB_ENV
          else
            echo "Dockerfile not found. Skipping Docker build."
          fi

      - name: Set up QEMU
        if: env.DOCKERFILE_EXISTS == 'true'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: env.DOCKERFILE_EXISTS == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: env.DOCKERFILE_EXISTS == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        if: env.DOCKERFILE_EXISTS == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', 'main') }}
            type=sha,enable=true,prefix=sha-

      - name: Build and push Docker image
        if: env.DOCKERFILE_EXISTS == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }} # Only push on push events, not pull requests
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha # GitHub Actions cache for Docker layers
          cache-to: type=gha,mode=max # Store Docker layers in GHA cache
