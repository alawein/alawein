name: Unified Documentation Pipeline

on:
  push:
    branches: [main, develop]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - 'mkdocs.yaml'
      - '.metaHub/**/*.md'
      - 'README.md'
      - '**/README.md'
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - 'mkdocs.yaml'
  workflow_dispatch:
    inputs:
      deploy_to_pages:
        description: 'Deploy to GitHub Pages'
        required: false
        type: boolean
        default: true
      validate_only:
        description: 'Only validate docs without deploying'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: docs-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Job 1: Validate Documentation
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install MkDocs and plugins
        run: |
          echo "üìö Installing MkDocs and plugins..."
          pip install mkdocs-material
          pip install mkdocs-mermaid2-plugin
          pip install mkdocs-minify-plugin
          pip install mkdocs-git-revision-date-localized-plugin
          echo "‚úÖ MkDocs installed"
      
      - name: Validate MkDocs configuration
        run: |
          echo "üîç Validating MkDocs configuration..."
          if [ -f "mkdocs.yml" ] || [ -f "mkdocs.yaml" ]; then
            python -c "import yaml; yaml.safe_load(open('mkdocs.yml' if __import__('os').path.exists('mkdocs.yml') else 'mkdocs.yaml'))"
            echo "‚úÖ MkDocs configuration is valid"
          else
            echo "::warning::No mkdocs.yml or mkdocs.yaml found"
          fi
      
      - name: Check for broken links in markdown
        run: |
          echo "üîó Checking for broken internal links..."
          
          # Find all markdown files
          find docs -name "*.md" -type f | while read file; do
            # Extract markdown links
            grep -oP '\[.*?\]\(\K[^)]+' "$file" | while read link; do
              # Skip external links
              if [[ ! "$link" =~ ^https?:// ]]; then
                # Check if file exists
                if [[ "$link" =~ ^/ ]]; then
                  target="docs${link}"
                else
                  dir=$(dirname "$file")
                  target="$dir/$link"
                fi
                
                if [ ! -f "$target" ] && [ ! -d "$target" ]; then
                  echo "::warning::Broken link in $file: $link"
                fi
              fi
            done
          done || true
      
      - name: Check documentation structure
        run: |
          echo "üìÅ Checking documentation structure..."
          
          # Check for required files
          required_files=("docs/index.md" "README.md")
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ Found: $file"
            else
              echo "::warning::Missing: $file"
            fi
          done
          
          # Check for empty markdown files
          find docs -name "*.md" -type f -empty | while read file; do
            echo "::warning::Empty markdown file: $file"
          done || true
      
      - name: Validate markdown syntax
        run: |
          echo "üìù Validating markdown syntax..."
          
          # Check for common markdown issues
          find docs -name "*.md" -type f | while read file; do
            # Check for unclosed code blocks
            if [ $(grep -c '```' "$file") -ne $(( $(grep -c '```' "$file") / 2 * 2 )) ]; then
              echo "::warning::Unclosed code block in $file"
            fi
            
            # Check for missing alt text in images
            if grep -q '!\[\](' "$file"; then
              echo "::notice::Missing alt text for images in $file"
            fi
          done || true
          
          echo "‚úÖ Markdown validation completed"
      
      - name: Setup Node.js for link validation
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Validate internal links
        run: |
          echo "üîó Validating internal documentation links..."
          node scripts/docs/validate-links.js docs || echo "::warning::Found broken links - see output above"
      
      - name: Create validation summary
        run: |
          echo "## Documentation Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Performed:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ MkDocs configuration validation" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Broken link detection" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Documentation structure check" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Markdown syntax validation" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Internal link validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count markdown files
          md_count=$(find docs -name "*.md" -type f | wc -l)
          echo "- Total markdown files: $md_count" >> $GITHUB_STEP_SUMMARY

  # Job 2: Build Documentation
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    needs: validate-docs
    if: |
      always() && 
      needs.validate-docs.result == 'success' &&
      (github.event.inputs.validate_only != 'true')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for git-revision-date plugin
      
      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install MkDocs and plugins
        run: |
          echo "üìö Installing MkDocs and plugins..."
          pip install mkdocs-material
          pip install mkdocs-mermaid2-plugin
          pip install mkdocs-minify-plugin
          pip install mkdocs-git-revision-date-localized-plugin
          echo "‚úÖ MkDocs installed"
      
      - name: Build documentation (strict mode)
        id: build_strict
        run: |
          echo "üî® Building documentation in strict mode..."
          mkdocs build --strict
          echo "‚úÖ Documentation built successfully (strict mode)"
        continue-on-error: true
      
      - name: Build documentation (lenient mode)
        if: steps.build_strict.outcome == 'failure'
        run: |
          echo "‚ö†Ô∏è Strict build failed, building in lenient mode..."
          mkdocs build
          echo "‚úÖ Documentation built (lenient mode)"
          echo "::warning::Documentation built with warnings - review build logs"
      
      - name: Check build output
        run: |
          echo "üìä Checking build output..."
          
          if [ -d "site" ]; then
            size=$(du -sh site | cut -f1)
            files=$(find site -type f | wc -l)
            
            echo "## Build Statistics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Build size: $size" >> $GITHUB_STEP_SUMMARY
            echo "- Total files: $files" >> $GITHUB_STEP_SUMMARY
            echo "- Build mode: ${{ steps.build_strict.outcome == 'success' && 'strict' || 'lenient' }}" >> $GITHUB_STEP_SUMMARY
            
            echo "‚úÖ Build output validated"
          else
            echo "::error::Build output directory not found"
            exit 1
          fi
      
      - name: Upload build artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: site/
          retention-days: 7
      
      - name: Upload build for preview
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: docs-preview-${{ github.event.pull_request.number }}
          path: site/
          retention-days: 7

  # Job 3: Deploy to GitHub Pages
  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-docs
    if: |
      always() &&
      needs.build-docs.result == 'success' &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      (github.event.inputs.deploy_to_pages != 'false')
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Log deployment
        run: |
          echo "## Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìÑ Documentation deployed to: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Details:" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

  # Job 4: Documentation Summary
  docs-summary:
    name: Documentation Summary
    runs-on: ubuntu-latest
    needs: [validate-docs, build-docs, deploy-pages]
    if: always()
    
    steps:
      - name: Create comprehensive summary
        run: |
          echo "# üìö Documentation Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate-docs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build-docs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy-pages.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine overall status
          if [ "${{ needs.validate-docs.result }}" == "success" ] && \
             [ "${{ needs.build-docs.result }}" == "success" ]; then
            if [ "${{ needs.deploy-pages.result }}" == "success" ]; then
              echo "‚úÖ **Documentation validated, built, and deployed successfully!**" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.deploy-pages.result }}" == "skipped" ]; then
              echo "‚úÖ **Documentation validated and built successfully!**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "‚ÑπÔ∏è Deployment skipped (not on main branch or manual override)" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ö†Ô∏è **Documentation built but deployment failed**" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "${{ needs.validate-docs.result }}" == "success" ]; then
            echo "‚ö†Ô∏è **Documentation validated but build failed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Documentation validation failed**" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const validation = '${{ needs.validate-docs.result }}';
            const build = '${{ needs.build-docs.result }}';
            
            let body = '## üìö Documentation Pipeline Results\n\n';
            body += '| Stage | Status |\n';
            body += '|-------|--------|\n';
            body += `| Validation | ${validation === 'success' ? '‚úÖ' : '‚ùå'} ${validation} |\n`;
            body += `| Build | ${build === 'success' ? '‚úÖ' : build === 'skipped' ? '‚è≠' : '‚ùå'} ${build} |\n`;
            body += '\n';
            
            if (validation === 'success' && build === 'success') {
              body += '‚úÖ Documentation changes look good!\n\n';
              body += `Preview artifact: \`docs-preview-${{ github.event.pull_request.number }}\`\n`;
            } else if (validation === 'success') {
              body += '‚ö†Ô∏è Documentation validated but build had issues.\n';
            } else {
              body += '‚ùå Documentation validation failed. Please review the errors above.\n';
            }
            
            body += `\n[View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
