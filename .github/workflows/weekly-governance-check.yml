name: Weekly Governance Compliance Check

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  ORGANIZATIONS: 'alawein-business alawein-science alawein-tools AlaweinOS MeatheadPhysicist'

jobs:
  compliance-check:
    name: Governance Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout governance repo
        uses: actions/checkout@v4
        with:
          path: governance

      - name: Clone organization monorepos
        run: |
          mkdir -p governance/organizations
          for org in $ORGANIZATIONS; do
            echo "Cloning $org/monorepo..."
            git clone --depth=1 "https://github.com/$org/monorepo.git" "governance/organizations/$org" || echo "Warning: Failed to clone $org"
          done
          echo "Cloned organizations:"
          ls -la governance/organizations/

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          cd governance
          python -m pip install --upgrade pip
          pip install -r .metaHub/scripts/requirements.txt
          pip install PyYAML

      - name: Run structure validation
        id: structure_check
        continue-on-error: true
        run: |
          cd governance
          python .metaHub/scripts/structure_validator.py organizations/ --report json --output compliance-report.json || echo '{"summary": {"total_orgs": 0, "total_repos": 0, "compliant_repos": 0}}' > compliance-report.json

      - name: Run governance enforcement check
        id: governance_check
        continue-on-error: true
        run: |
          cd governance
          python .metaHub/scripts/enforce.py organizations/ --report json --output governance-report.json || echo '{"repos": [], "summary": {}}' > governance-report.json

      - name: Run AI audit on monorepos
        id: ai_audit
        continue-on-error: true
        run: |
          cd governance
          python .metaHub/scripts/ai_audit.py --report json -o ai-audit-report.json organizations/ 2>/dev/null || echo '{"summary": {"score": 0, "total_violations": 0, "total_warnings": 0}}' > ai-audit-report.json

      - name: Generate compliance summary
        id: summary
        run: |
          cd governance
          python -c "
          import json
          import os
          from datetime import datetime

          # Load reports
          compliance = {}
          governance = {}
          ai_audit = {}

          if os.path.exists('compliance-report.json'):
              with open('compliance-report.json') as f:
                  compliance = json.load(f)

          if os.path.exists('governance-report.json'):
              with open('governance-report.json') as f:
                  governance = json.load(f)

          if os.path.exists('ai-audit-report.json'):
              with open('ai-audit-report.json') as f:
                  ai_audit = json.load(f)

          # Get AI audit summary
          audit_summary = ai_audit.get('summary', {})
          score = audit_summary.get('score', 0)
          violations = audit_summary.get('total_violations', 0)
          warnings = audit_summary.get('total_warnings', 0)

          # Generate summary
          summary = {
              'timestamp': datetime.now().isoformat(),
              'compliance': compliance.get('summary', {}),
              'governance': governance,
              'ai_audit': {
                  'score': score,
                  'violations': violations,
                  'warnings': warnings
              }
          }

          with open('weekly-summary.json', 'w') as f:
              json.dump(summary, f, indent=2)

          # Set outputs using environment file
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'score={score}\n')
              f.write(f'violations={violations}\n')
              f.write(f'warnings={warnings}\n')
              f.write(f'total-repos={compliance.get(\"summary\", {}).get(\"total_repos\", 0)}\n')

          print(f'AI Audit Score: {score}/100')
          print(f'Violations: {violations}')
          print(f'Warnings: {warnings}')
          "

      - name: Create compliance issue
        if: steps.summary.outputs.violations > 0 || steps.summary.outputs.score < 85
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('governance/weekly-summary.json', 'utf8'));

            const score = summary.ai_audit.score;
            const violations = summary.ai_audit.violations;
            const warnings = summary.ai_audit.warnings;

            const body = '## Weekly Governance Compliance Report\n\n' +
              'Generated: ' + new Date().toISOString() + '\n\n' +
              '### AI Audit Summary\n' +
              '- **Score**: ' + score + '/100\n' +
              '- **Violations**: ' + violations + '\n' +
              '- **Warnings**: ' + warnings + '\n\n' +
              '### Organizations Checked\n' +
              '- alawein-business/monorepo\n' +
              '- alawein-science/monorepo\n' +
              '- alawein-tools/monorepo\n' +
              '- AlaweinOS/monorepo\n' +
              '- MeatheadPhysicist/monorepo\n\n' +
              '### Action Required\n' +
              (violations > 0 ? '**CRITICAL**: ' + violations + ' violations found. Immediate action required.\n' : '') +
              (score < 85 ? 'Score below 85%. Manual review recommended.\n' : 'Score acceptable.\n') +
              '\n[View detailed report](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId + ')';

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['governance-compliance'],
              state: 'open'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Weekly Governance: Score ' + score + '/100, ' + violations + ' violations',
                body: body,
                labels: ['governance-compliance', 'automated']
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
            }

      - name: Upload compliance reports
        uses: actions/upload-artifact@v4
        with:
          name: governance-compliance-reports
          path: |
            governance/compliance-report.json
            governance/governance-report.json
            governance/ai-audit-report.json
            governance/weekly-summary.json
          retention-days: 30

      - name: Final status check
        run: |
          cd governance
          if [ -f ai-audit-report.json ]; then
            violations=$(python -c "import json; print(json.load(open('ai-audit-report.json')).get('summary', {}).get('total_violations', 0))")
            if [ "$violations" -gt "0" ]; then
              echo "::error::$violations governance violations found!"
              exit 1
            fi
          fi
          echo "Governance check passed!"
