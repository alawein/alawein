#!/bin/bash

echo "üö® META GOVERNANCE: Pre-commit hook activated"

# Meta governance repository - policy and documentation checks only

# 0. Run lint-staged for TypeScript/JavaScript files (if available)
if [ -f "package.json" ] && command -v npx &> /dev/null; then
    if grep -q "lint-staged" package.json 2>/dev/null; then
        echo "üîß Running lint-staged..."
        npx lint-staged
        if [ $? -ne 0 ]; then
            echo "‚ùå COMMIT BLOCKED: lint-staged failed"
            exit 1
        fi
    fi
fi

# 1. Check protected files
if [ -f "tools/scripts/check-protected-files.sh" ]; then
    bash tools/scripts/check-protected-files.sh
fi

# 2. Security scan (if package.json exists) - warning only, don't block
if [ -f "package.json" ]; then
    echo "üîí Running security scan..."
    npm audit --audit-level=moderate 2>/dev/null || echo "‚ö†Ô∏è  WARNING: Security vulnerabilities found (run 'npm audit fix')"
fi

# 3. Check for secrets in committed files
echo "üîë Scanning for secrets..."
if git diff --cached --name-only | xargs grep -E "(password|secret|api[_-]*key|token)" 2>/dev/null | grep -v ".metaHub/"; then
    echo "‚ö†Ô∏è  WARNING: Potential secrets found in staged files"
    echo "Review carefully before committing"
    # Don't block - may be intentional documentation
fi

# 4. Validate YAML files (workflows and configs, excluding templates with placeholders)
echo "üìã Validating YAML files..."
for file in $(git diff --cached --name-only | grep -E '\.(yml|yaml)$' | grep -v '^templates/'); do
    if [ -f "$file" ]; then
        # Basic YAML syntax check (if yq or python available)
        if command -v python &> /dev/null; then
            python -c "import yaml; yaml.safe_load(open('$file', encoding='utf-8'))" 2>/dev/null
            if [ $? -ne 0 ]; then
                echo "‚ùå COMMIT BLOCKED: Invalid YAML in $file"
                exit 1
            fi
        fi
    fi
done

# 5. Validate markdown files (if markdownlint available)
if command -v markdownlint &> /dev/null; then
    echo "üìù Validating Markdown files..."
    git diff --cached --name-only | grep -E '\.md$' | xargs markdownlint 2>/dev/null || true
fi

# 6. Validate documentation links (check for broken internal links)
if [ -f "scripts/docs/validate-links.js" ]; then
    # Check if any markdown files are being committed in docs/
    if git diff --cached --name-only | grep -qE '^docs/.*\.md$'; then
        echo "üîó Validating documentation links..."
        node scripts/docs/validate-links.js docs 2>/dev/null
        if [ $? -ne 0 ]; then
            echo "‚ö†Ô∏è  WARNING: Some documentation links may be broken"
            echo "Run 'npm run docs:validate-links' to see details"
            # Don't block commit - just warn
        fi
    fi
fi

# 7. Check file sizes (KILO enforcement - max 500 lines per file)
echo "üìè Checking file sizes..."
MAX_LINES=500
violations=0

for file in $(git diff --cached --name-only | grep -E '\.(ts|js|py)$' | grep -E '^(tools/cli|tools/lib)'); do
    if [ -f "$file" ]; then
        lines=$(wc -l < "$file" 2>/dev/null || echo "0")
        if [ "$lines" -gt "$MAX_LINES" ]; then
            echo "‚ùå $file has $lines lines (max $MAX_LINES)"
            violations=$((violations + 1))
        fi
    fi
done

if [ $violations -gt 0 ]; then
    echo "‚ùå COMMIT BLOCKED: $violations file(s) exceed $MAX_LINES line limit"
    echo "üí° Refactor large files into smaller, focused modules"
    exit 1
fi

echo "‚úÖ META GOVERNANCE CHECKS PASSED - Commit allowed"
echo "üéâ Governance policies and documentation are valid"
