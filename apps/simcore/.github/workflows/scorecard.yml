name: OpenSSF Scorecard Security Analysis

on:
  # Run weekly on Saturday
  schedule:
    - cron: '30 1 * * 6'

  # Run on main branch pushes
  push:
    branches:
      - main
      - master

  # Allow manual runs
  workflow_dispatch:

# Permissions for SARIF upload
permissions:
  contents: read
  security-events: write
  id-token: write
  actions: read

jobs:
  analysis:
    name: Scorecard Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Run OpenSSF Scorecard
        uses: ossf/scorecard-action@v2.4.0
        with:
          results_file: results.sarif
          results_format: sarif

          # Publish results to OpenSSF REST API
          publish_results: true

          # Enable all 18 security checks
          # - Binary-Artifacts
          # - Branch-Protection
          # - CI-Tests
          # - CII-Best-Practices
          # - Code-Review
          # - Contributors
          # - Dangerous-Workflow
          # - Dependency-Update-Tool (Renovate/Dependabot)
          # - Fuzzing
          # - License
          # - Maintained
          # - Packaging
          # - Pinned-Dependencies
          # - SAST
          # - Security-Policy
          # - Signed-Releases
          # - Token-Permissions
          # - Vulnerabilities

      # Upload SARIF results to GitHub Security tab
      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif

      # Upload results as artifact for historical tracking
      - name: Upload results artifact
        uses: actions/upload-artifact@v4
        with:
          name: scorecard-results-${{ github.sha }}
          path: results.sarif
          retention-days: 90

      - name: Generate summary report
        if: always()
        run: |
          echo "## OpenSSF Scorecard Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Security analysis completed for commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Performed (18 total):" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Binary-Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Branch-Protection" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ CI-Tests" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ CII-Best-Practices" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Code-Review" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Contributors" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Dangerous-Workflow" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Dependency-Update-Tool (Renovate)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Fuzzing" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ License" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Maintained" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Packaging" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Pinned-Dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ SAST" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Security-Policy" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Signed-Releases" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Token-Permissions" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed results in the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning)" >> $GITHUB_STEP_SUMMARY

  # Store scorecard results in repository
  store-results:
    name: Store Scorecard Results
    runs-on: ubuntu-latest
    needs: analysis
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download scorecard results
        uses: actions/download-artifact@v4
        with:
          name: scorecard-results-${{ github.sha }}
          path: .metaHub/security/scorecard/

      - name: Commit scorecard results
        run: |
          git config user.name "OpenSSF Scorecard Bot"
          git config user.email "scorecard-bot@github.com"

          # Create timestamped filename
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          mkdir -p .metaHub/security/scorecard/history
          cp .metaHub/security/scorecard/results.sarif ".metaHub/security/scorecard/history/scorecard-${TIMESTAMP}.sarif"

          # Keep only last 10 results
          cd .metaHub/security/scorecard/history
          ls -t scorecard-*.sarif | tail -n +11 | xargs -r rm --

          git add .metaHub/security/scorecard/
          git commit -m "chore(security): update OpenSSF Scorecard results [${TIMESTAMP}]" || echo "No changes to commit"
          git push || echo "Push failed or no changes"
