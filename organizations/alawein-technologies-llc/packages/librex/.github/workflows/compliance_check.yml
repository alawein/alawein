name: Librex Compliance Check

on:
  workflow_call:

env:
  PYTHON_VERSION: '3.11'
  MIN_TEST_COVERAGE: 85
  MAX_GAP_QAP: 15
  MAX_GAP_TSP: 5

jobs:
  academic-integrity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: Verify citation format compliance
        run: |
          find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*" | xargs grep -l "@\|doi:\|arxiv:" | head -10
      - name: Validate research attribution
        run: |
          if find . -name "*.md" -o -name "*.py" | xargs grep -l "Lin-Kernighan\|EAX\|Memetic\|Elite ACO" 2>/dev/null; then
            find . -name "*.md" | xargs grep -l "citation\|reference\|doi\|arxiv" | xargs grep -i "lin-kernighan\|eax\|memetic\|elite.*aco" || exit 1
          fi
      - name: Check licensing compliance
        run: |
          test -f LICENSE || exit 1
          grep -q 'license = {text = "Apache-2.0"}' pyproject.toml || exit 1

  benchmarking-validation:
    runs-on: ubuntu-latest
    needs: academic-integrity
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: Validate benchmarking guides exist
        run: |
          test -f "BENCHMARKING_GUIDE.md" || exit 1
          test -f "QAPLIB_BENCHMARKING_GUIDE.md" || exit 1
      - name: Check publication gate standards
        run: |
          grep -q "gap.*≤.*${MAX_GAP_QAP}%" BENCHMARKING_GUIDE.md || exit 1
          grep -q "gap.*≤.*${MAX_GAP_TSP}%" BENCHMARKING_GUIDE.md || exit 1
      - name: Validate statistical analysis methods
        run: |
          grep -q "confidence.*interval\|bootstrap\|statistical" BENCHMARKING_GUIDE.md || exit 1
          grep -q "hypothesis.*test\|p-value\|significance" BENCHMARKING_GUIDE.md || exit 1

  code-quality:
    runs-on: ubuntu-latest
    needs: benchmarking-validation
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: Lint
        run: ruff check .
      - name: Typecheck
        run: mypy Librex/ --ignore-missing-imports
      - name: Format check
        run: black --check .
      - name: Tests with coverage
        run: pytest --cov=Librex --cov-report=xml --cov-report=term
      - name: Validate minimum coverage
        run: |
          COVERAGE=$(grep -o 'line-rate="[0-9.]*"' coverage.xml | head -1 | sed 's/.*="\([0-9.]*\)".*/\1/')
          PERCENT=$(python3 -c "import os; val='${COVERAGE}'; print(int(round(float(val)*100)))")
          if [ "$PERCENT" -lt "$MIN_TEST_COVERAGE" ]; then
            echo "Coverage ${PERCENT}% is below minimum ${MIN_TEST_COVERAGE}%"
            exit 1
          fi
          echo "Coverage ${PERCENT}% meets minimum ${MIN_TEST_COVERAGE}%"

  documentation-standards:
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Validate documentation structure
        run: |
          for doc in ADVANCED_METHODS.md RESEARCH_FINDINGS.md PEER_REVIEW_VERIFICATION.md TAXONOMY_CLASSIFICATION.md BACKWARD_COMPATIBILITY.md; do
            test -f "$doc" || exit 1
          done
      - name: Validate Universal Adapter Pattern
        run: |
          grep -r "Domain Problem.*Adapter.*StandardizedProblem.*Method.*Solution" . --include="*.md" || grep -r "Universal Adapter Pattern" . --include="*.md" || exit 1

  integration-testing:
    runs-on: ubuntu-latest
    needs: documentation-standards
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: Import checks
        run: |
          python3 -c "from Librex import __version__; print(__version__); from Librex.methods import baselines; print('OK'); import os; print('QAPLIB exists' if os.path.exists('qaplib') else 'NO_QAPLIB')"

  compliance-report:
    runs-on: ubuntu-latest
    needs: [academic-integrity, benchmarking-validation, code-quality, documentation-standards, integration-testing]
    if: always()
    steps:
      - uses: actions/checkout@v4
      - name: Generate compliance summary
        run: |
          echo "# Librex Compliance Check Report" > compliance_report.md
          echo "Generated on: $(date)" >> compliance_report.md
          echo "| Check | Status |" >> compliance_report.md
          echo "|-------|--------|" >> compliance_report.md
          echo "| Academic Integrity | ${{ needs.academic-integrity.result }} |" >> compliance_report.md
          echo "| Benchmarking Standards | ${{ needs.benchmarking-validation.result }} |" >> compliance_report.md
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> compliance_report.md
          echo "| Documentation Standards | ${{ needs.documentation-standards.result }} |" >> compliance_report.md
          echo "| Integration Testing | ${{ needs.integration-testing.result }} |" >> compliance_report.md
      - uses: actions/upload-artifact@v4
        with:
          name: compliance-report
          path: compliance_report.md