apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: mezan-ORCHEX-ingress
  namespace: mezan-ORCHEX
  labels:
    app.kubernetes.io/name: mezan-ORCHEX
    app.kubernetes.io/component: ingress
    app.kubernetes.io/part-of: mezan
  annotations:
    # Nginx Ingress Controller annotations
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/rewrite-target: /$1
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-rpm: "1000"
    nginx.ingress.kubernetes.io/limit-connections: "20"

    # Timeouts
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"

    # CORS
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"

    # Security Headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: SAMEORIGIN";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
      more_set_headers "Content-Security-Policy: default-src 'self'";

    # Cert Manager for automatic TLS
    cert-manager.io/cluster-issuer: letsencrypt-prod
    cert-manager.io/acme-challenge-type: http01

    # AWS ALB Ingress Controller (alternative)
    # kubernetes.io/ingress.class: alb
    # alb.ingress.kubernetes.io/scheme: internet-facing
    # alb.ingress.kubernetes.io/target-type: ip
    # alb.ingress.kubernetes.io/healthcheck-path: /health
    # alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:region:account:certificate/id

    # GKE Ingress Controller (alternative)
    # kubernetes.io/ingress.class: gce
    # ingress.gcp.kubernetes.io/pre-shared-cert: "mezan-ORCHEX-cert"
    # cloud.google.com/backend-config: '{"default": "mezan-ORCHEX-backend-config"}'

spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - mezan-ORCHEX.example.com
    - api.mezan-ORCHEX.example.com
    secretName: mezan-ORCHEX-tls
  rules:
  - host: mezan-ORCHEX.example.com
    http:
      paths:
      - path: /api/(.*)
        pathType: Prefix
        backend:
          service:
            name: mezan-ORCHEX-nginx
            port:
              number: 80
      - path: /
        pathType: Prefix
        backend:
          service:
            name: mezan-ORCHEX-nginx
            port:
              number: 80
  - host: api.mezan-ORCHEX.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: mezan-ORCHEX-api
            port:
              number: 5000

---
# BackendConfig for GKE (if using GKE)
apiVersion: cloud.google.com/v1
kind: BackendConfig
metadata:
  name: mezan-ORCHEX-backend-config
  namespace: mezan-ORCHEX
spec:
  timeoutSec: 300
  connectionDraining:
    drainingTimeoutSec: 30
  healthCheck:
    checkIntervalSec: 10
    timeoutSec: 5
    healthyThreshold: 2
    unhealthyThreshold: 3
    type: HTTP
    requestPath: /health
    port: 5000
  cdn:
    enabled: true
    cachePolicy:
      includeHost: true
      includeProtocol: true
      includeQueryString: false
    negativeCaching: true
    negativeCachingPolicy:
    - code: 404
      ttl: 120
    - code: 410
      ttl: 120
  iap:
    enabled: false
    oauthclientCredentials:
      secretName: oauth-client-secret
  sessionAffinity:
    affinityType: "CLIENT_IP"
    affinityCookieTtlSec: 86400