name: disaster_recovery
version: 1.0.0
category: resilience
description: Disaster recovery orchestration with automated failover and data restoration
author: ORCHEX Team
tags:
  - disaster-recovery
  - backup
  - failover
  - restoration
  - business-continuity

parameters:
  recovery_type:
    type: string
    description: Type of recovery to perform
    required: true
    allowed_values: [full, partial, failover, rollback]

  primary_region:
    type: string
    description: Primary region identifier
    required: true

  recovery_region:
    type: string
    description: Recovery region identifier
    required: true

  rpo_minutes:
    type: int
    description: Recovery Point Objective in minutes
    required: false
    default: 15

  rto_minutes:
    type: int
    description: Recovery Time Objective in minutes
    required: false
    default: 60

  backup_source:
    type: string
    description: Backup source location
    required: true

  verification_level:
    type: string
    description: Level of verification after recovery
    required: false
    default: comprehensive
    allowed_values: [minimal, standard, comprehensive]

  enable_dry_run:
    type: bool
    description: Perform dry run without actual changes
    required: false
    default: false

workflow:
  config:
    type: disaster_recovery
    priority: critical
    monitoring: real_time

  tasks:
    - name: assess_situation
      type: assessment
      description: Assess current disaster situation
      parameters:
        checks:
          - service_health:
              region: "{{primary_region}}"
              services: all
          - data_integrity:
              recent_backups: 5
              verify_checksums: true
          - network_connectivity:
              regions: ["{{primary_region}}", "{{recovery_region}}"]
          - resource_availability:
              region: "{{recovery_region}}"
              required_capacity: auto

    - name: trigger_emergency_backup
      type: backup
      description: Trigger emergency backup if possible
      depends_on: [assess_situation]
      condition: "${assess_situation.primary_accessible} == true"
      timeout: 300
      parameters:
        source_region: "{{primary_region}}"
        backup_type: incremental
        priority: highest
        compress: true
        encrypt: true

    - name: notify_stakeholders
      type: notification
      description: Notify stakeholders about DR activation
      depends_on: [assess_situation]
      parameters:
        recipients:
          - role: incident_commander
          - role: operations_team
          - role: executive_team
        channels: [email, sms, slack, pagerduty]
        message:
          severity: critical
          recovery_type: "{{recovery_type}}"
          estimated_rto: "{{rto_minutes}}"

    - name: activate_dr_mode
      type: activation
      description: Activate disaster recovery mode
      depends_on: [notify_stakeholders]
      parameters:
        mode: "{{recovery_type}}"
        dry_run: "{{enable_dry_run}}"
        actions:
          - suspend_primary_writes
          - enable_read_only_mode
          - redirect_traffic_to_recovery

    - name: identify_recovery_point
      type: recovery_point
      description: Identify optimal recovery point
      depends_on: [activate_dr_mode]
      parameters:
        rpo_target: "{{rpo_minutes}}"
        backup_source: "{{backup_source}}"
        selection_criteria:
          - data_completeness: 0.99
          - consistency_check: true
          - maximum_age_minutes: "{{rpo_minutes}}"

    - name: prepare_recovery_infrastructure
      type: infrastructure_prep
      description: Prepare recovery infrastructure
      depends_on: [identify_recovery_point]
      parameters:
        region: "{{recovery_region}}"
        infrastructure:
          - compute:
              instance_type: auto_scale
              min_instances: 10
              max_instances: 100
          - storage:
              type: high_performance
              size: auto
              replication: multi_az
          - network:
              vpc: disaster_recovery
              subnets: [public, private]
              security_groups: restrictive
          - database:
              engine: same_as_primary
              size: auto_scale

    - name: restore_data
      type: parallel
      description: Restore data in parallel
      depends_on: [prepare_recovery_infrastructure]
      subtasks:
        - name: restore_databases
          type: database_restore
          parameters:
            source: "${identify_recovery_point.database_backup}"
            target: "{{recovery_region}}/databases"
            parallel_streams: 8
            verify_integrity: true

        - name: restore_file_storage
          type: storage_restore
          parameters:
            source: "${identify_recovery_point.storage_backup}"
            target: "{{recovery_region}}/storage"
            sync_method: parallel
            bandwidth_limit: unlimited

        - name: restore_cache_state
          type: cache_restore
          parameters:
            source: "${identify_recovery_point.cache_snapshot}"
            target: "{{recovery_region}}/cache"
            warm_cache: true

        - name: restore_message_queues
          type: queue_restore
          parameters:
            source: "${identify_recovery_point.queue_backup}"
            target: "{{recovery_region}}/queues"
            preserve_order: true

    - name: verify_data_restoration
      type: verification
      description: Verify data restoration completeness
      depends_on: [restore_data]
      parameters:
        verification_level: "{{verification_level}}"
        checks:
          - row_counts:
              tolerance: 0.001
          - checksums:
              sample_rate: 0.1
          - referential_integrity:
              full_scan: "${verification_level} == 'comprehensive'"
          - business_rules:
              critical_only: "${verification_level} == 'minimal'"

    - name: restore_configurations
      type: config_restore
      description: Restore application configurations
      depends_on: [verify_data_restoration]
      parameters:
        config_source: "${identify_recovery_point.config_backup}"
        target_region: "{{recovery_region}}"
        override_values:
          region: "{{recovery_region}}"
          dr_mode: true
          primary_region: "{{primary_region}}"

    - name: start_applications
      type: application_start
      description: Start applications in recovery region
      depends_on: [restore_configurations]
      parameters:
        region: "{{recovery_region}}"
        startup_sequence:
          - tier: database
            wait_healthy: true
          - tier: cache
            wait_healthy: true
          - tier: backend
            canary_deployment: true
            canary_percentage: 10
          - tier: frontend
            gradual_rollout: true
        health_checks:
          interval: 10
          timeout: 300

    - name: smoke_tests
      type: testing
      description: Run smoke tests
      depends_on: [start_applications]
      parameters:
        test_suite: disaster_recovery
        tests:
          - connectivity: all_services
          - authentication: basic_flow
          - core_functionality: critical_paths
          - data_access: read_write
        fail_fast: false

    - name: performance_validation
      type: performance_test
      description: Validate performance meets requirements
      depends_on: [smoke_tests]
      parameters:
        baseline: production_metrics
        thresholds:
          response_time_p95: 200
          throughput: 0.8
          error_rate: 0.01
        duration: 300

    - name: traffic_switchover
      type: traffic_management
      description: Switch traffic to recovery region
      depends_on: [performance_validation]
      parameters:
        strategy: gradual
        stages:
          - percentage: 5
            duration: 300
            rollback_on_error: true
          - percentage: 25
            duration: 600
          - percentage: 50
            duration: 600
          - percentage: 100
            duration: 0
        monitoring:
          error_threshold: 0.05
          latency_threshold: 500

    - name: update_dns
      type: dns_update
      description: Update DNS to point to recovery region
      depends_on: [traffic_switchover]
      parameters:
        records:
          - type: A
            name: "api.example.com"
            value: "${recovery_region.load_balancer}"
          - type: CNAME
            name: "www.example.com"
            value: "${recovery_region.cdn}"
        ttl: 60
        verify_propagation: true

    - name: verify_recovery
      type: comprehensive_verification
      description: Comprehensive recovery verification
      depends_on: [update_dns]
      parameters:
        checks:
          - end_to_end_tests: full_suite
          - data_consistency: cross_region
          - monitoring_metrics: all_dashboards
          - alert_status: no_criticals
          - user_experience: synthetic_monitoring

    - name: document_recovery
      type: documentation
      description: Document recovery process
      depends_on: [verify_recovery]
      parameters:
        report_sections:
          - timeline: "${workflow.execution_log}"
          - recovery_point: "${identify_recovery_point.details}"
          - data_loss: "${verify_data_restoration.data_loss_report}"
          - performance: "${performance_validation.results}"
          - issues_encountered: "${workflow.errors}"
          - lessons_learned: auto_generate

    - name: post_recovery_tasks
      type: cleanup
      description: Post-recovery cleanup and optimization
      depends_on: [document_recovery]
      parameters:
        tasks:
          - optimize_resources:
              right_size: true
              remove_unused: true
          - update_runbooks:
              based_on: lessons_learned
          - schedule_drills:
              frequency: quarterly
          - backup_verification:
              new_primary: "{{recovery_region}}"

dependencies:
  - disaster_recovery_toolkit
  - infrastructure_as_code
  - monitoring_suite

metadata:
  compliance:
    standards: [ISO22301, SOC2, HIPAA]
    audit_requirements: true

  recovery_tiers:
    tier_0:
      rpo: 0
      rto: 15
      description: "Zero data loss, immediate failover"
    tier_1:
      rpo: 15
      rto: 60
      description: "Minimal data loss, quick recovery"
    tier_2:
      rpo: 60
      rto: 240
      description: "Acceptable data loss, standard recovery"