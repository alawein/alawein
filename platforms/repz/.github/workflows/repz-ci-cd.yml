name: REPZ CI/CD Pipeline

on:
  push:
    branches: ["app/dev", "app/main", "production"]
  pull_request:
    branches: ["app/main", "production"]
  workflow_dispatch:

env:
  NODE_VERSION: "20"
  SUPABASE_CLI_VERSION: "1.123.3"

jobs:
  # Quality Assurance
  qa:
    name: Quality Assurance
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.changes.outputs.should_deploy }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check

      - name: Lint code
        run: npm run lint

      - name: Run unit tests
        run: npm run test:run -- --coverage

      - name: Run integration tests
        run: npm run test:integration

      - name: Check for critical changes
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # Database Migration
  migrate:
    name: Database Migration
    runs-on: ubuntu-latest
    needs: qa
    if: needs.qa.outputs.should_deploy == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: ${{ env.SUPABASE_CLI_VERSION }}

      - name: Link to Supabase project
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/app/dev" ]]; then
            supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF_DEV }}
          elif [[ "${{ github.ref }}" == "refs/heads/app/main" ]]; then
            supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF_STAGING }}
          else
            supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF_PROD }}
          fi

      - name: Push database changes
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

  # Deploy Functions
  deploy-functions:
    name: Deploy Edge Functions
    runs-on: ubuntu-latest
    needs: [qa, migrate]
    if: needs.qa.outputs.should_deploy == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: ${{ env.SUPABASE_CLI_VERSION }}

      - name: Link to Supabase project
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/app/dev" ]]; then
            supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF_DEV }}
          elif [[ "${{ github.ref }}" == "refs/heads/app/main" ]]; then
            supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF_STAGING }}
          else
            supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF_PROD }}
          fi

      - name: Deploy functions
        run: supabase functions deploy
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

  # Deploy to Vercel (Development)
  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [qa, migrate, deploy-functions]
    if: github.ref == 'refs/heads/app/dev'
    environment: development

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_DEV_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_DEV_ANON_KEY }}
          VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_TEST_PUBLISHABLE_KEY }}

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_DEV }}
          vercel-args: "--prod"
          working-directory: ./

      - name: Run smoke tests
        run: npm run test:smoke -- --env=dev

  # Deploy to Vercel (Staging)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [qa, migrate, deploy-functions]
    if: github.ref == 'refs/heads/app/main'
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build:production
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_STAGING_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_STAGING_ANON_KEY }}
          VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_TEST_PUBLISHABLE_KEY }}

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_STAGING }}
          vercel-args: "--prod"
          working-directory: ./

      - name: Run E2E tests
        run: npm run test:e2e -- --env=staging

      - name: Run performance tests
        run: npm run test:performance -- --env=staging

      - name: Update Stripe test webhooks
        run: |
          curl -X POST https://api.stripe.com/v1/webhook_endpoints/whsec_${{ secrets.STRIPE_WEBHOOK_SECRET_STAGING }}/url \
            -u ${{ secrets.STRIPE_TEST_KEY }}: \
            -d "url=https://staging.repzcoach.com/api/stripe/webhook"

  # Deploy to Vercel (Production)
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [qa, migrate, deploy-functions]
    if: github.ref == 'refs/heads/production'
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Create deployment backup
        run: |
          echo "Creating backup of current deployment..."
          # Add backup logic here if needed

      - name: Build application
        run: npm run build:production
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_PROD_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_PROD_ANON_KEY }}
          VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_LIVE_PUBLISHABLE_KEY }}

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_PROD }}
          vercel-args: "--prod"
          working-directory: ./

      - name: Run health checks
        run: npm run test:health -- --env=production

      - name: Run smoke tests
        run: npm run test:smoke -- --env=production

      - name: Update Stripe live webhooks
        run: |
          curl -X POST https://api.stripe.com/v1/webhook_endpoints/whsec_${{ secrets.STRIPE_WEBHOOK_SECRET_PROD }}/url \
            -u ${{ secrets.STRIPE_LIVE_KEY }}: \
            -d "url=https://app.repzcoach.com/api/stripe/webhook"

      - name: Notify deployment
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: "#deployments"
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          text: "ðŸš€ REPZ Production deployment completed successfully!"
        if: always()

  # Security Scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: qa
    if: github.ref == 'refs/heads/production'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Run CodeQL analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@v3

  # Preview Deployment for PRs
  preview:
    name: Preview Deployment
    runs-on: ubuntu-latest
    needs: qa
    if: github.event_name == 'pull_request'
    environment: preview

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.SUPABASE_STAGING_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_STAGING_ANON_KEY }}
          VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_TEST_PUBLISHABLE_KEY }}

      - name: Deploy preview to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID_STAGING }}
          alias-domains: pr-${{ github.event.number }}.repzcoach.com
          working-directory: ./

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview deployment')
            );

            const comment = botComment || {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            };

            await github.rest.issues.createComment({
              ...comment,
              body: `## ðŸš€ Preview Deployment\n\nYour REPZ preview is ready at: https://pr-${context.issue.number}.repzcoach.com\n\nBuilt from commit: ${context.sha.slice(0, 7)}`,
            });
