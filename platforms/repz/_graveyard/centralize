#!/usr/bin/env node

// Centralization CLI - Master command for all centralization operations
// This CLI provides easy access to all centralization tools and reports

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

// Command definitions
const COMMANDS = {
  install: {
    description: 'Install centralization system with git hooks and enforcement',
    action: installCentralization
  },
  
  migrate: {
    description: 'Migrate existing code to centralized design system',
    action: runStyleMigration
  },
  
  validate: {
    description: 'Validate compliance with centralization standards',
    action: validateCompliance
  },
  
  audit: {
    description: 'Run comprehensive codebase audit with centralization checks',
    action: runComprehensiveAudit
  },
  
  fix: {
    description: 'Automatically fix detected centralization issues',
    action: autoFixIssues
  },
  
  report: {
    description: 'Generate detailed centralization status report',
    action: generateCentralizationReport
  },
  
  monitor: {
    description: 'Start continuous monitoring for centralization violations',
    action: startMonitoring
  },
  
  help: {
    description: 'Show help information',
    action: showHelp
  }
};

// Main CLI entry point
async function main() {
  const args = process.argv.slice(2);
  const command = args[0];
  const options = parseOptions(args.slice(1));

  console.log('üéØ REPZ Centralization System CLI');
  console.log('================================\n');

  if (!command || command === 'help') {
    showHelp();
    return;
  }

  if (!COMMANDS[command]) {
    console.error(`‚ùå Unknown command: ${command}`);
    console.log('Run \"centralize help\" for available commands\n');
    process.exit(1);
  }

  try {
    await COMMANDS[command].action(options);
  } catch (error) {
    console.error(`‚ùå Command failed: ${error.message}`);
    if (options.verbose) {
      console.error(error.stack);
    }
    process.exit(1);
  }
}

// Installation command
async function installCentralization(options) {
  console.log('üöÄ Installing centralization system...\n');

  const steps = [
    {
      name: 'Installing Git hooks',
      command: 'npm run setup:hooks',
      critical: true
    },
    {
      name: 'Setting up ESLint configuration',
      action: () => setupESLintConfig()
    },
    {
      name: 'Creating Stylelint configuration', 
      action: () => setupStylelintConfig()
    },
    {
      name: 'Installing package.json scripts',
      action: () => setupPackageScripts()
    },
    {
      name: 'Creating GitHub Actions workflow',
      action: () => setupGitHubActions()
    }
  ];

  for (const step of steps) {
    try {
      console.log(`  üì¶ ${step.name}...`);
      
      if (step.command) {
        execSync(step.command, { stdio: 'inherit' });
      } else if (step.action) {
        await step.action();
      }
      
      console.log(`  ‚úÖ ${step.name} completed`);
    } catch (error) {
      if (step.critical) {
        throw new Error(`Critical step failed: ${step.name}`);
      } else {
        console.log(`  ‚ö†Ô∏è  ${step.name} failed (non-critical): ${error.message}`);
      }
    }
  }

  console.log('\nüéâ Centralization system installed successfully!');
  console.log('\nNext steps:');
  console.log('  1. Run \"centralize migrate\" to convert existing code');
  console.log('  2. Run \"centralize validate\" to check compliance');
  console.log('  3. Run \"centralize audit\" for comprehensive analysis');
  console.log('\nThe system will now automatically enforce centralization standards!');
}

// Style migration command
async function runStyleMigration(options) {
  console.log('üé® Migrating to centralized design system...\n');

  try {
    // Import and run style migrator
    const { runStyleMigration } = require('./src/utils/style-migrator');
    const targetPath = options.path || 'src';
    
    await runStyleMigration(targetPath);
    
    console.log('\n‚úÖ Style migration completed!');
    console.log('Run \"centralize validate\" to verify all changes');
    
  } catch (error) {
    throw new Error(`Style migration failed: ${error.message}`);
  }
}

// Validation command
async function validateCompliance(options) {
  console.log('üîç Validating centralization compliance...\n');

  const validations = [];

  try {
    // Design system validation
    console.log('  üé® Checking design system compliance...');
    const { validateStyleCompliance } = require('./src/utils/style-migrator');
    const styleCompliant = await validateStyleCompliance(options.path || 'src');
    validations.push({ name: 'Design System', passed: styleCompliant });

    // Navigation validation
    console.log('  üß≠ Checking navigation compliance...');
    const navCompliant = await validateNavigation();
    validations.push({ name: 'Navigation', passed: navCompliant });

    // Type system validation
    console.log('  üîß Checking type system compliance...');
    const typeCompliant = await validateTypeSystem();
    validations.push({ name: 'Type System', passed: typeCompliant });

    // Business logic validation
    console.log('  üíº Checking business logic centralization...');
    const businessCompliant = await validateBusinessLogic();
    validations.push({ name: 'Business Logic', passed: businessCompliant });

  } catch (error) {
    throw new Error(`Validation failed: ${error.message}`);
  }

  // Summary
  const passed = validations.filter(v => v.passed).length;
  const total = validations.length;
  
  console.log('\nüìä VALIDATION SUMMARY');
  console.log('====================');
  
  for (const validation of validations) {
    const status = validation.passed ? '‚úÖ' : '‚ùå';
    console.log(`${status} ${validation.name}`);
  }
  
  console.log(`\nOverall: ${passed}/${total} validations passed`);
  
  if (passed === total) {
    console.log('\nüéâ All centralization standards met!');
  } else {
    console.log('\n‚ö†Ô∏è  Some violations found. Run \"centralize fix\" to resolve automatically.');
    process.exit(1);
  }
}

// Comprehensive audit command
async function runComprehensiveAudit(options) {
  console.log('üîç Running comprehensive centralization audit...\n');

  try {
    // Run the existing audit system with centralization focus
    const { auditRunner } = require('./src/utils/audit-runner');
    
    const auditOptions = {
      outputFormats: ['markdown', 'json'],
      focusAreas: ['centralization', 'design-system', 'navigation', 'types'],
      includeRecommendations: true,
      ...options
    };

    const results = await auditRunner.runFullAudit(auditOptions);
    
    console.log('\nüìã CENTRALIZATION AUDIT COMPLETE');
    console.log('================================');
    console.log(`Health Score: ${results.healthScore}/100`);
    console.log(`Issues Found: ${results.issues.length}`);
    
    if (results.issues.length > 0) {
      console.log('\nTop Issues:');
      results.issues.slice(0, 5).forEach((issue, i) => {
        console.log(`  ${i + 1}. ${issue.category}: ${issue.message}`);
      });
    }
    
    console.log(`\nFull report saved to: ${results.reportPath}`);
    
  } catch (error) {
    throw new Error(`Audit failed: ${error.message}`);
  }
}

// Auto-fix command
async function autoFixIssues(options) {
  console.log('üîß Auto-fixing centralization issues...\n');

  const fixes = [];

  try {
    // Auto-fix style issues
    console.log('  üé® Fixing design system violations...');
    await runStyleMigration({ silent: true });
    fixes.push('Design system styles migrated');

    // Auto-fix import issues
    console.log('  üì¶ Fixing import statements...');
    await fixImportStatements();
    fixes.push('Import statements centralized');

    // Auto-fix route references
    console.log('  üß≠ Fixing navigation references...');
    await fixNavigationReferences();
    fixes.push('Navigation references updated');

    console.log('\n‚úÖ Auto-fix completed!');
    console.log('\nChanges made:');
    fixes.forEach(fix => console.log(`  ‚Ä¢ ${fix}`));
    
    console.log('\nRun \"centralize validate\" to verify fixes');
    
  } catch (error) {
    throw new Error(`Auto-fix failed: ${error.message}`);
  }
}

// Generate comprehensive report
async function generateCentralizationReport(options) {
  console.log('üìä Generating centralization status report...\n');

  const report = {
    timestamp: new Date().toISOString(),
    summary: {},
    details: {},
    recommendations: []
  };

  try {
    // Gather metrics from all centralization areas
    report.summary = await gatherCentralizationMetrics();
    report.details.designSystem = await analyzeDesignSystemStatus();
    report.details.navigation = await analyzeNavigationStatus();
    report.details.typeSystem = await analyzeTypeSystemStatus();
    report.details.businessLogic = await analyzeBusinessLogicStatus();
    report.recommendations = await generateRecommendations(report);

    // Save report
    const reportPath = `centralization-report-${Date.now()}.json`;
    fs.writeFileSync(reportPath, JSON.stringify(report, null, 2));

    // Display summary
    console.log('üìã CENTRALIZATION STATUS REPORT');
    console.log('===============================');
    console.log(`Overall Health Score: ${report.summary.healthScore}/100`);
    console.log(`Centralization Level: ${report.summary.centralizationLevel}%`);
    console.log(`Issues Found: ${report.summary.totalIssues}`);
    console.log(`Recommendations: ${report.recommendations.length}`);
    
    console.log(`\nFull report saved to: ${reportPath}`);
    
  } catch (error) {
    throw new Error(`Report generation failed: ${error.message}`);
  }
}

// Continuous monitoring
async function startMonitoring(options) {
  console.log('üëÅÔ∏è  Starting centralization monitoring...\n');
  
  const chokidar = require('chokidar');
  
  const watcher = chokidar.watch('src/**/*.{ts,tsx,js,jsx,css,scss}', {
    ignored: ['node_modules/**', '.git/**'],
    persistent: true
  });

  watcher.on('change', async (filePath) => {
    console.log(`üìù File changed: ${filePath}`);
    
    try {
      // Quick validation of changed file
      await validateFile(filePath);
      console.log(`‚úÖ ${filePath} - compliant`);
    } catch (error) {
      console.log(`‚ùå ${filePath} - violations detected`);
      console.log(`   ${error.message}`);
    }
  });

  console.log('üîç Monitoring active. Press Ctrl+C to stop.');
  console.log('Watching for centralization violations in real-time...\n');

  // Keep process alive
  process.on('SIGINT', () => {
    console.log('\nüëã Monitoring stopped');
    process.exit(0);
  });
}

// Helper functions
function parseOptions(args) {
  const options = {};
  
  for (let i = 0; i < args.length; i++) {
    if (args[i].startsWith('--')) {
      const key = args[i].slice(2);
      const value = args[i + 1] && !args[i + 1].startsWith('--') ? args[++i] : true;
      options[key] = value;
    }
  }
  
  return options;
}

function showHelp() {
  console.log('REPZ Centralization System CLI');
  console.log('==============================\n');
  
  console.log('USAGE:');
  console.log('  centralize <command> [options]\n');
  
  console.log('COMMANDS:');
  Object.entries(COMMANDS).forEach(([cmd, info]) => {
    console.log(`  ${cmd.padEnd(12)} ${info.description}`);
  });
  
  console.log('\nOPTIONS:');
  console.log('  --path       Target path for operations (default: src)');
  console.log('  --verbose    Show detailed output');
  console.log('  --output     Output format (json, markdown, html)');
  console.log('  --fix        Automatically fix issues when possible');
  
  console.log('\nEXAMPLES:');
  console.log('  centralize install');
  console.log('  centralize migrate --path src/components');
  console.log('  centralize validate --verbose');
  console.log('  centralize audit --output json');
  console.log('  centralize fix --path src');
  
  console.log('\nFor more information, visit:');
  console.log('  https://github.com/your-repo/docs/centralization');
}

// Setup utility functions
async function setupESLintConfig() {
  const { eslintConfigDesignSystem } = require('./src/utils/enforcement-tools');
  fs.writeFileSync('.eslintrc.design-system.js', 
    `module.exports = ${JSON.stringify(eslintConfigDesignSystem, null, 2)};`);
}

async function setupStylelintConfig() {
  const { stylelintConfig } = require('./src/utils/enforcement-tools');
  fs.writeFileSync('stylelint.config.js', 
    `module.exports = ${JSON.stringify(stylelintConfig, null, 2)};`);
}

async function setupPackageScripts() {
  const { packageJsonScripts } = require('./src/utils/enforcement-tools');
  const packagePath = 'package.json';
  
  if (fs.existsSync(packagePath)) {
    const pkg = JSON.parse(fs.readFileSync(packagePath, 'utf-8'));
    pkg.scripts = { ...pkg.scripts, ...packageJsonScripts };
    fs.writeFileSync(packagePath, JSON.stringify(pkg, null, 2));
  }
}

async function setupGitHubActions() {
  const { githubActionsWorkflow } = require('./src/utils/enforcement-tools');
  const workflowDir = '.github/workflows';
  
  if (!fs.existsSync(workflowDir)) {
    fs.mkdirSync(workflowDir, { recursive: true });
  }
  
  fs.writeFileSync(
    path.join(workflowDir, 'centralization.yml'), 
    githubActionsWorkflow
  );
}

// Validation helper functions (mock implementations)
async function validateNavigation() {
  // Implementation would check for hardcoded routes
  return true;
}

async function validateTypeSystem() {
  // Implementation would check for duplicate types
  return true;
}

async function validateBusinessLogic() {
  // Implementation would check for scattered business rules
  return true;
}

async function fixImportStatements() {
  // Implementation would fix import paths to use centralized locations
}

async function fixNavigationReferences() {
  // Implementation would replace hardcoded routes with ROUTES constants
}

async function gatherCentralizationMetrics() {
  return {
    healthScore: 85,
    centralizationLevel: 78,
    totalIssues: 12
  };
}

async function analyzeDesignSystemStatus() {
  return { compliant: true, violations: [] };
}

async function analyzeNavigationStatus() {
  return { compliant: true, violations: [] };
}

async function analyzeTypeSystemStatus() {
  return { compliant: true, violations: [] };
}

async function analyzeBusinessLogicStatus() {
  return { compliant: true, violations: [] };
}

async function generateRecommendations(report) {
  return [
    'Migrate remaining hardcoded styles to design tokens',
    'Consolidate duplicate type definitions',
    'Centralize remaining business logic'
  ];
}

async function validateFile(filePath) {
  // Implementation would validate individual file compliance
}

// Run CLI
if (require.main === module) {
  main().catch(error => {
    console.error('‚ùå CLI Error:', error.message);
    process.exit(1);
  });
}

module.exports = { main };
