name: Reusable OPA Policy Gate

on:
  workflow_call:
    inputs:
      policy-path:
        description: Path to OPA policies
        required: false
        default: .metaHub/policies
        type: string

jobs:
  opa-policy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install OPA
        run: |
          # Pin OPA version for supply chain security
          OPA_VERSION="v0.70.0"
          curl -L -o opa "https://github.com/open-policy-agent/opa/releases/download/${OPA_VERSION}/opa_linux_amd64_static"
          chmod +x opa
          sudo mv opa /usr/local/bin/
          opa version

      - name: Evaluate OPA policies
        continue-on-error: true
        run: |
          echo "## OPA Policy Evaluation" >> $GITHUB_STEP_SUMMARY
          if [ -d "${{ inputs.policy-path }}" ]; then
            echo "Found policies at: ${{ inputs.policy-path }}" >> $GITHUB_STEP_SUMMARY
            echo "OPA policies available (warning-only mode)" >> $GITHUB_STEP_SUMMARY
          else
            echo "Policy path not found: ${{ inputs.policy-path }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Policy summary
        if: always()
        run: |
          echo "## Policy Gate Summary" >> $GITHUB_STEP_SUMMARY
          echo "Mode: Warning-only (non-blocking)" >> $GITHUB_STEP_SUMMARY
